<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>週間ルーティン表（上：時間割／下：設定）</title>
<style>
  :root {
    --bg: #f7f7f8;
    --card: #ffffff;
    --ink: #1f2328;
    --muted: #6a737d;
    --line: #e5e7eb;
    --acc: #4f46e5;
  }
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic", "Segoe UI Emoji", "Apple Color Emoji", "Noto Color Emoji", sans-serif;}
  .wrap{max-width:1100px;margin:16px auto;padding:0 12px;}
  h1{font-size:18px;margin:8px 0 12px}
  h2{font-size:16px;margin:16px 0 8px}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
  .toolbar .spacer{flex:1}
  .btn{border:1px solid var(--line);background:var(--card);padding:8px 10px;border-radius:8px;cursor:pointer}
  .btn.primary{background:var(--acc);color:#fff;border-color:transparent}
  .btn.ghost{background:transparent}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  input[type="date"]{padding:7px 8px;border:1px solid var(--line);border-radius:8px;background:#fff}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;box-shadow:0 1px 0 rgba(0,0,0,.02)}
  .grid{overflow:auto}
  table{border-collapse:separate;border-spacing:0;width:100%;min-width:760px}
  th,td{border-bottom:1px solid var(--line);border-right:1px solid var(--line);vertical-align:top}
  th:first-child, td:first-child{border-left:1px solid var(--line)}
  thead th{position:sticky;top:0;background:#fafafa;z-index:1}
  th,td{padding:8px}
  th{font-weight:600}
  td.routine, th.routine{width:180px;background:#fafafa;position:sticky;left:0;z-index:2}
  .cell-muted{color:var(--muted);font-size:12px}
  .todo{display:flex;align-items:center;gap:6px;margin:4px 0}
  .todo input[type="checkbox"]{width:16px;height:16px}
  .chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  .chip{border:1px solid var(--line);padding:5px 8px;border-radius:999px;cursor:pointer;font-size:12px;background:#fff}
  .chip.active{background:#eef2ff;border-color:#c7d2fe;color:#3730a3}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .col{flex:1;min-width:260px}
  .list{display:flex;flex-direction:column;gap:8px}
  .item{border:1px solid var(--line);border-radius:10px;padding:10px}
  .muted{color:var(--muted);font-size:12px}
  .input, textarea{width:100%;padding:8px;border:1px solid var(--line);border-radius:8px;background:#fff}
  textarea{min-height:72px;resize:vertical}
  .section{padding:12px}
  .footer{margin-top:12px;color:var(--muted);font-size:12px;text-align:center}
  .del{color:#b91c1c;cursor:pointer;border:none;background:transparent;padding:0 6px}
  .small{font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <h1>週間ルーティン表</h1>

  <div class="card section toolbar">
    <div>週の基準日：<input type="date" id="datePicker"></div>
    <button class="btn" id="prevWeek">← 前の週</button>
    <button class="btn" id="nextWeek">次の週 →</button>
    <div class="spacer"></div>
    <button class="btn" id="clearChecks">この週のチェックをクリア</button>
  </div>

  <div class="card section grid" id="timetableCard">
    <div class="muted small" style="margin-bottom:8px">上：時間割（横：曜日／縦：ルーティン）</div>
    <div class="grid">
      <table id="timetable"></table>
    </div>
    <div style="margin-top:10px">
      <label for="weeklyMemo"><strong>週メモ</strong>（この週の振り返り・注意点など）</label>
      <textarea id="weeklyMemo" placeholder="例）夜勤入りはモーニング短縮／木はエアロ→ストレッチに切替…"></textarea>
    </div>
  </div>

  <div class="card section" id="settings">
    <div class="muted small" style="margin-bottom:8px">下：設定（ルーティン作成／ToDo登録／曜日割当）</div>
    <div class="row">
      <div class="col">
        <h2>ルーティン管理</h2>
        <div class="item">
          <label class="small">新規ルーティン名</label>
          <input class="input" id="newRoutineName" placeholder="例）モーニング、ナイト、仮眠明け 等" />
          <div class="chips" id="newRoutineDays"></div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn primary" id="addRoutine">＋ 追加</button>
          </div>
        </div>

        <div class="list" id="routineList"></div>
      </div>
      <div class="col">
        <h2>ToDo管理</h2>
        <div class="item">
          <label class="small">対象ルーティン</label>
          <select class="input" id="todoRoutineSelect"></select>
          <label class="small" style="margin-top:8px">ToDo内容</label>
          <input class="input" id="newTodoText" placeholder="例）英単語25語、エアロバイク、掃除…" />
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn" id="addTodo">＋ ToDo追加</button>
          </div>
          <div class="muted small" style="margin-top:6px">
            ※ ToDoは「ルーティン」に属します。<br>
            ※ ルーティンに設定した曜日に、上の時間割へ自動で反映されます。
          </div>
        </div>

        <div class="item">
          <h3 style="margin:0 0 6px">この週のチェック操作</h3>
          <button class="btn" id="checkAllWeek">この週の全ToDoにチェック</button>
          <button class="btn" id="uncheckAllWeek">この週の全ToDoを未完了に</button>
        </div>
      </div>
    </div>
  </div>

  <div class="footer">ローカル保存（この端末・このブラウザのみ）。月曜始まり。</div>
</div>

<script>
(() => {
  const DAYS = ["月","火","水","木","金","土","日"]; // Monday=0
  const today = new Date();
  // --- Storage helpers ---
  const LS_KEY = "habit_routines_v1";
  function loadState(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return null;
      return JSON.parse(raw);
    }catch(e){ console.warn(e); return null; }
  }
  function saveState(){
    localStorage.setItem(LS_KEY, JSON.stringify(state));
  }
  function uid(){ return Math.random().toString(36).slice(2); }

  // --- Default state ---
  let state = loadState() || {
    routines: [
      {id: uid(), name: "モーニング", days: [0,1,2,3,4,5,6], todos: [
        {id: uid(), text: "英単語25語", done: {}},
        {id: uid(), text: "水分補給", done: {}}
      ]},
      {id: uid(), name: "仮眠明け", days: [2,4,6], todos: [
        {id: uid(), text: "ラジオ体操", done: {}}
      ]},
      {id: uid(), name: "ナイト", days: [0,1,2,3,4,5,6], todos: [
        {id: uid(), text: "ストレッチ", done: {}}
      ]}
    ],
    memoByWeek: {},
    currentDate: toISO(today)
  };

  // --- Week helpers ---
  function toISO(d){
    const z = new Date(d.getFullYear(), d.getMonth(), d.getDate());
    z.setMinutes(z.getMinutes()-z.getTimezoneOffset());
    return z.toISOString().slice(0,10);
  }
  function mondayOf(dateStr){
    const d = new Date(dateStr+"T00:00:00");
    let day = d.getDay(); // 0 Sun .. 6 Sat
    // Convert to Monday-start index
    const jsIndex = (day===0?6:day-1); // 0=Mon..6=Sun
    d.setDate(d.getDate() - jsIndex);
    return toISO(d);
  }
  function dateFromISO(s){ return new Date(s+"T00:00:00"); }
  function addDays(iso, n){
    const d = dateFromISO(iso);
    d.setDate(d.getDate()+n);
    return toISO(d);
  }
  function weekKeyFromDate(dateStr){
    return mondayOf(dateStr); // Use Monday ISO as key
  }

  // --- DOM refs ---
  const datePicker = document.getElementById("datePicker");
  const prevWeekBtn = document.getElementById("prevWeek");
  const nextWeekBtn = document.getElementById("nextWeek");
  const timetableEl = document.getElementById("timetable");
  const weeklyMemoEl = document.getElementById("weeklyMemo");

  const routineListEl = document.getElementById("routineList");
  const newRoutineNameEl = document.getElementById("newRoutineName");
  const newRoutineDaysEl = document.getElementById("newRoutineDays");
  const addRoutineBtn = document.getElementById("addRoutine");

  const todoRoutineSelectEl = document.getElementById("todoRoutineSelect");
  const newTodoTextEl = document.getElementById("newTodoText");
  const addTodoBtn = document.getElementById("addTodo");

  const clearChecksBtn = document.getElementById("clearChecks");
  const checkAllWeekBtn = document.getElementById("checkAllWeek");
  const uncheckAllWeekBtn = document.getElementById("uncheckAllWeek");

  // --- Init weekday chips for new routine ---
  function renderDayChips(container, daysArr, onToggle){
    container.innerHTML = "";
    DAYS.forEach((label, idx) => {
      const chip = document.createElement("button");
      chip.type = "button";
      chip.className = "chip" + (daysArr.includes(idx) ? " active" : "");
      chip.textContent = label;
      chip.addEventListener("pointerdown", (ev) => {ev.preventDefault();const i = daysArr.indexOf(idx);if(i>=0){ daysArr.splice(i,1); chip.classList.remove("active"); }else { daysArr.push(idx); daysArr.sort((a,b)=>a-b); chip.classList.add("active"); }if(onToggle) onToggle(daysArr); if(window.refreshTimetableDebounced) refreshTimetableDebounced();}, {passive:false});
      container.appendChild(chip);
    });
  }

  // new routine day select temp state
  let newRoutineDays = [0,1,2,3,4,5,6];
  renderDayChips(newRoutineDaysEl, newRoutineDays, () => renderDayChips(newRoutineDaysEl, newRoutineDays, null));

  // --- Routine List render ---
  function renderRoutineList(){
    routineListEl.innerHTML = "";
    state.routines.forEach(rt => {
      const div = document.createElement("div");
      div.className = "item";
      const title = document.createElement("div");
      title.style.display="flex";
      title.style.alignItems="center";
      title.style.justifyContent="space-between";
      const nameInput = document.createElement("input");
      nameInput.className = "input";
      nameInput.value = rt.name;
      nameInput.addEventListener("input", () => { rt.name = nameInput.value; syncRoutineSelect(); renderTimetable(); saveState(); });
      const delBtn = document.createElement("button");
      delBtn.className = "del";
      delBtn.textContent = "削除";
      delBtn.addEventListener("click", () => {
        if(!confirm(`「${rt.name}」を削除しますか？`)) return;
        state.routines = state.routines.filter(r => r.id!==rt.id);
        syncRoutineSelect();
        renderRoutineList();
        renderTimetable();
        saveState();
      });
      title.appendChild(nameInput);
      title.appendChild(delBtn);
      div.appendChild(title);

      const daysWrap = document.createElement("div");
      daysWrap.className = "chips";
      renderDayChips(daysWrap, rt.days, (newDays) => { rt.days = [...newDays]; saveState(); renderTimetable(); });
      div.appendChild(daysWrap);

      const todosBox = document.createElement("div");
      todosBox.className = "list";
      if(rt.todos.length===0){
        const p=document.createElement("div");
        p.className="muted small";
        p.textContent="ToDo未登録。右の「ToDo管理」から追加してください。";
        todosBox.appendChild(p);
      }else{
        rt.todos.forEach(td => {
          const row = document.createElement("div");
          row.style.display="flex";
          row.style.gap="8px";
          const txt = document.createElement("input");
          txt.className="input";
          txt.value = td.text;
          txt.addEventListener("input", ()=>{ td.text = txt.value; renderTimetable(); saveState(); });
          const del = document.createElement("button");
          del.className="del";
          del.textContent="削除";
          del.addEventListener("click", ()=>{
            rt.todos = rt.todos.filter(t => t.id!==td.id);
            renderRoutineList();
            renderTimetable();
            saveState();
          });
          row.appendChild(txt);
          row.appendChild(del);
          todosBox.appendChild(row);
        });
      }
      div.appendChild(todosBox);
      routineListEl.appendChild(div);
    });
  }

  function syncRoutineSelect(){
    todoRoutineSelectEl.innerHTML = "";
    state.routines.forEach(rt => {
      const opt = document.createElement("option");
      opt.value = rt.id;
      opt.textContent = rt.name;
      todoRoutineSelectEl.appendChild(opt);
    });
  }

  // --- Add routine ---
  addRoutineBtn.addEventListener("click", () => {
    const name = newRoutineNameEl.value.trim();
    if(!name) { alert("ルーティン名を入力してください"); return; }
    const r = { id: uid(), name, days: [...newRoutineDays], todos: [] };
    state.routines.push(r);
    newRoutineNameEl.value = "";
    renderRoutineList();
    syncRoutineSelect();
    renderTimetable();
    saveState();
  });

  // --- Add todo ---
  addTodoBtn.addEventListener("click", () => {
    const rid = todoRoutineSelectEl.value;
    const txt = newTodoTextEl.value.trim();
    if(!rid){ alert("対象ルーティンを選択してください"); return; }
    if(!txt){ alert("ToDo内容を入力してください"); return; }
    const rt = state.routines.find(r => r.id===rid);
    if(!rt) return;
    rt.todos.push({ id: uid(), text: txt, done: {} });
    newTodoTextEl.value = "";
    renderRoutineList();
    renderTimetable();
    saveState();
  });

  // --- Week controls ---
  function setCurrentDate(iso){
    state.currentDate = iso;
    saveState();
    datePicker.value = iso;
    renderTimetable();
    renderMemo();
  }
  function shiftWeek(delta){
    const monday = mondayOf(state.currentDate);
    const newMonday = addDays(monday, delta*7);
    setCurrentDate(newMonday);
  }
  prevWeekBtn.addEventListener("click", ()=>shiftWeek(-1));
  nextWeekBtn.addEventListener("click", ()=>shiftWeek(1));
  datePicker.addEventListener("change", (e)=>{
    const iso = e.target.value;
    if(iso) setCurrentDate(iso);
  });

  // --- Memo ---
  function renderMemo(){
    const wk = weekKeyFromDate(state.currentDate);
    weeklyMemoEl.value = state.memoByWeek[wk] || "";
  }
  weeklyMemoEl.addEventListener("input", ()=>{
    const wk = weekKeyFromDate(state.currentDate);
    state.memoByWeek[wk] = weeklyMemoEl.value;
    saveState();
  });

  // --- Timetable render ---
  function renderTimetable(){
    const monday = mondayOf(state.currentDate);
    const headerDates = DAYS.map((_,i)=> addDays(monday, i)); // ISO per weekday
    const wk = weekKeyFromDate(state.currentDate);

    // Build table
    const thead = document.createElement("thead");
    const htr = document.createElement("tr");
    const h0 = document.createElement("th");
    h0.className = "routine";
    h0.textContent = "ルーティン＼曜日";
    htr.appendChild(h0);
    DAYS.forEach((d,i)=>{
      const th = document.createElement("th");
      th.textContent = `${d}（${headerDates[i].slice(5).replace("-","/")}）`;
      htr.appendChild(th);
    });
    thead.appendChild(htr);

    const tbody = document.createElement("tbody");
    state.routines.forEach(rt => {
      const tr = document.createElement("tr");
      const td0 = document.createElement("td");
      td0.className = "routine";
      td0.textContent = rt.name;
      tr.appendChild(td0);

      DAYS.forEach((label, dayIdx) => {
        const td = document.createElement("td");
        if(!rt.days.includes(dayIdx)){
          td.innerHTML = `<span class="cell-muted">（休）</span>`;
        } else if(rt.todos.length===0){
          td.innerHTML = `<span class="cell-muted">ToDoなし</span>`;
        } else {
          rt.todos.forEach(todo => {
            const row = document.createElement("div");
            row.className = "todo";
            const cb = document.createElement("input");
            cb.type="checkbox";
            const key = wk + "|" + dayIdx;
            cb.checked = !!todo.done[key];
            cb.addEventListener("change", ()=>{
              if(cb.checked) todo.done[key] = true;
              else delete todo.done[key];
              saveState();
            });
            const labelEl = document.createElement("label");
            labelEl.textContent = todo.text;
            row.appendChild(cb);
            row.appendChild(labelEl);
            td.appendChild(row);
          });
        }
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });

    timetableEl.innerHTML = "";
    timetableEl.appendChild(thead);
    timetableEl.appendChild(tbody);
  }

  // --- Clear / Check all for current week ---
  clearChecksBtn.addEventListener("click", ()=>{
    if(!confirm("この週のチェックをすべてクリアしますか？")) return;
    const wk = weekKeyFromDate(state.currentDate);
    state.routines.forEach(rt => {
      rt.todos.forEach(td => {
        for(let i=0;i<7;i++){
          const key = wk + "|" + i;
          delete td.done[key];
        }
      });
    });
    renderTimetable();
    saveState();
  });

  checkAllWeekBtn.addEventListener("click", ()=>{
    const wk = weekKeyFromDate(state.currentDate);
    state.routines.forEach(rt => {
      rt.todos.forEach(td => {
        for(let i=0;i<7;i++){
          if(rt.days.includes(i)){
            const key = wk + "|" + i;
            td.done[key] = true;
          }
        }
      });
    });
    renderTimetable();
    saveState();
  });
  uncheckAllWeekBtn.addEventListener("click", ()=>{
    const wk = weekKeyFromDate(state.currentDate);
    state.routines.forEach(rt => {
      rt.todos.forEach(td => {
        for(let i=0;i<7;i++){
          const key = wk + "|" + i;
          delete td.done[key];
        }
      });
    });
    renderTimetable();
    saveState();
  });

  // --- First paint ---
  datePicker.value = state.currentDate;
  renderRoutineList();
  syncRoutineSelect();
  renderTimetable();
  renderMemo();
})();

// --- debounce timetable refresh so multiple day taps don't re-render every time ---
let __ttDebounce = null;
function refreshTimetableDebounced(){
  try{
    // keep scroll position to avoid jump
    const y = window.scrollY;
    clearTimeout(__ttDebounce);
    __ttDebounce = setTimeout(()=>{
      if(typeof saveState==='function') saveState();
      if(typeof renderTimetable==='function') renderTimetable();
      window.scrollTo(0, y);
    }, 500); // 0.5s after last tap
  }catch(e){ /* noop */ }
}

</script>
</body>
</html>
